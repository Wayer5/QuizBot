{% extends "base.html" %} {% block title %}Профиль пользователя{% endblock title
%} {% block stylesheets %}
<!-- Здесь можно добавить дополнительные стили, если необходимо -->
<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
/>
{% endblock stylesheets %} {% block content %}
<div class="container">
  <h3 class="text-center">Профиль пользователя:<br />{{ user.name }}</h3>
</div>

<div class="container mt-4">
  <div class="mb-4">
    <h4>Краткая информация о результатах</h4>
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <p class="small">
          <strong>Общее количество вопросов:</strong> {{ total_questions }}
        </p>
        <p class="small">
          <strong>Количество правильных ответов:</strong> {{
          correct_answers_count }}
        </p>
      </div>
    </div>
  </div>

  <div class="result-section mb-4">
    <h4>Информация о пройденных викторинах</h4>

    {% if quiz_results %}
    <div class="list-group">
      {% for result in quiz_results %}
      <div class="list-group-item">
        <h5>{{ result.quiz.title if result.quiz else 'Нет данных' }}</h5>
        <p>
          <strong>Общее количество вопросов:</strong> {{ result.total_questions
          }}<br />
          <strong>Количество правильных ответов:</strong> {{
          result.correct_answers_count }}
        </p>

        <!-- Кнопка для отображения полной информации -->
        <button
          class="btn btn-secondary shadow"
          data-toggle="collapse"
          data-target="#details-{{ result.id }}"
        >
          Полная информация
        </button>

        <!-- Выдвигающийся блок с полной информацией -->
        <div id="details-{{ result.id }}" class="collapse mt-2">
          <p><strong>Детали по вопросам:</strong></p>
          {% for question in result.questions %}
          <div>
            <strong>{{ question.title }}</strong><br />
            <em>Ваш ответ: {{ question.user_answer }}</em><br />
            <em>Правильный ответ: {{ question.correct_answer }}</em><br />
            {% if question.explanation %}
            <em>{{ question.explanation }}</em><br />
            {% endif %}
          </div>
          <hr />
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-center">Нет информации о результатах.</p>
    {% endif %}
  </div>

  <div class="text-center btn-container mt-4 mb-4">
    <a href="/" class="btn btn-primary">На главную</a>
    <form
      id="delete-profile-form"
      action="{{ url_for('delete_profile') }}"
      method="POST"
      onsubmit="return confirm('Вы уверены, что хотите удалить свой профиль?');"
      style="display: inline"
    >
      <input type="hidden" name="csrf_token" />
      <button id="delete-profile-form" type="submit" class="btn btn-danger">
        Удалить профиль
      </button>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  // Обработка отправки формы для удаления профиля
  document
    .getElementById("delete-profile-form")
    .addEventListener("submit", function (event) {
      event.preventDefault(); // Предотвращаем стандартное поведение формы

      const form = this; // Ссылка на форму

      // Отправляем форму
      fetch(form.action, {
        method: form.method,
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams(new FormData(form)).toString(), // Преобразуем данные формы в URL-кодированную строку
      })
        .then((response) => {
          if (response.ok) {
            alert("Профиль успешно удален!");
            closeWebApp(); // Закрытие веб-приложения после успешного удаления
          } else {
            alert("Ошибка при удалении профиля");
          }
        })
        .catch((error) => {
          console.error("Ошибка:", error);
          alert("Произошла ошибка при удалении профиля");
        });
    });

  // Функция для закрытия веб-приложения
  function closeWebApp() {
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.close();
    } else {
      console.log("Telegram Web Apps не поддерживаются в этом окружении.");
    }
  }
</script>

{% endblock content %}
